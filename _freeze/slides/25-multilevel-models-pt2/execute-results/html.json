{
  "hash": "609599dbd81773f37b0f3b06acebffe7",
  "result": {
    "markdown": "---\ntitle: \"Fitting multilevel models\"\nauthor: \"Prof. Maria Tackett\"\ndate: \"2022-11-30\"\ndate-format: \"MMM DD, YYYY\"\nfooter: \"[üîó Week 14](https://sta210-fa22.netlify.app/weeks/week-14.html)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    multiplex: false\n    transition: fade\n    slide-number: true\n    incremental: false \n    chalkboard: true\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n\n## Announcements\n\n-   Due dates\n\n    -   [Statistics experience](../hw/stats-experience.html) due Fri, Dec 09, 11:59pm\n    -   Project written report due Fri, Dec 09, 11:59pm\n    -   Team Feedback #2 due Tue, Dec 06, 11:59pm (check for email from Teammates)\n\n-   Exam 02: Mon, Dec 05 (evening) - Thu, Dec 08, 12pm (noon)\n\n    -   Exam 02 review on Mon Dec 05\n\n    -   [Click here](https://duke.hosted.panopto.com/Panopto/Pages/Sessions/List.aspx?folderID=3abb0b6f-0db5-4d55-84f2-aefd0140874b) for lecture recordings - available until Dec 05, 11:59pm\n\n-   See [Week 14](../weeks/week-14.html) activities\n\n------------------------------------------------------------------------\n\n## Learning goals\n\n-   Understand how multilevel model can be used to take correlation into account\n-   Interpret fixed effects of multilevel model\n-   Fit multilevel model in R\n\n## Data: Music performance anxiety\n\nThe data [`musicdata.csv`](data/musicdata.csv) come from the Sadler and Miller (2010) study of the emotional state of musicians before performances. The dataset contains information collected from 37 undergraduate music majors who completed the Positive Affect Negative Affect Schedule (PANAS), an instrument produces a measure of anxiety (negative affect) and a measure of happiness (positive affect). This analysis will focus on negative affect as a measure of performance anxiety.\n\n## Data: Music performance anxiety\n\nThe primary variables we'll use are\n\n-   **`na`**: negative affect score on PANAS (the response variable)\n-   **`perform_type`**: type of performance (Solo, Large Ensemble, Small Ensemble)\n    -   Create variable `large_ensemble`: 1 if large ensemble performance, 0 otherwise\n-   **`instrument`**: type of instrument (Voice, Orchestral, Piano)\n    -   Create variable `orchestra`: 1 if orchestral instrument, 0 otherwise\n\n## Look at data\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n| id| diary| large_ensemble| orchestra| na|\n|--:|-----:|--------------:|---------:|--:|\n|  1|     1|              0|         0| 11|\n|  1|     2|              1|         0| 19|\n|  1|     3|              1|         0| 14|\n| 43|     1|              0|         0| 19|\n| 43|     2|              0|         0| 13|\n| 43|     3|              0|         0| 19|\n:::\n:::\n\n\n::: question\nDraw the data structure, and add the Level One and Level Two observational units and variables.\n:::\n\n## Unviariate EDA\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](25-multilevel-models-pt2_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Bivariate EDA\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](25-multilevel-models-pt2_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Bivariate EDA\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](25-multilevel-models-pt2_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n# Fitting the model\n\n------------------------------------------------------------------------\n\n## Questions we want to answer\n\nThe goal is to understand variability in performance anxiety (`na`) based on performance-level and musician-level characteristics. Specifically:\n\n> What is the association between performance type (large ensemble or not) and performance anxiety? Does the association differ based on instrument type (orchestral or not)?\n\n## Modeling workflow\n\nWe will fit the model in two parts:\n\n1Ô∏è‚É£ Fit a separate model for each musician understand the association between performance type and anxiety (Level One models).\n\n2Ô∏è‚É£ Then fit a system of models to predict the fitted coefficients in the Level One models based on instrument type (Level Two models).\n\n::: question\n-   How many Level One models will we fit?\n-   How many Level Two models will we fit?\n:::\n\n## 1Ô∏è‚É£ Level One model\n\nWe'll start with the Level One model to understand the association between performance type and performance anxiety for the $i^{th}$ musician.\\\n\n$$na_{ij} = a_i + b_i ~ LargeEnsemble_{ij} + \\epsilon_i, \\hspace{5mm} \\epsilon_{ij} \\sim N(0,\\sigma^2)$$\n\n\n::: question\nWhy is it more meaningful to use performance type for the Level One model than instrument?\n:::\n\n. . .\n\nFor now, estimate $a_i$ and $b_i$ using least-squares regression.\n\n## Level One model for one student\n\nBelow is partial data for observation #22\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n| id| diary| large_ensemble| orchestra| na|\n|--:|-----:|--------------:|---------:|--:|\n| 22|     1|              0|         1| 24|\n| 22|     2|              1|         1| 21|\n| 22|     3|              1|         1| 14|\n| 22|    13|              1|         1| 12|\n| 22|    14|              1|         1| 19|\n| 22|    15|              0|         1| 25|\n:::\n:::\n\n\n## Level One model for musician 22 {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nid_22 <- music |>\n  filter(id == 22)\n\nlinear_reg() |>\n  set_engine(\"lm\") |>\n  fit(na ~ large_ensemble, data = id_22) |>\n  tidy() |> kable(digits = 3)\n```\n\n::: {.cell-output-display}\n|term           | estimate| std.error| statistic| p.value|\n|:--------------|--------:|---------:|---------:|-------:|\n|(Intercept)    |   24.500|      1.96|    12.503|   0.000|\n|large_ensemble |   -7.833|      2.53|    -3.097|   0.009|\n:::\n:::\n\n\n## Application exercise\n\n::: appex\nüìã [AE 15: Introduction to Multilevel models](../ae/ae-15-multilevel-models.html)\n:::\n\nSee Part 3: Level One Models to fit the Level One model for all 37 musicians.\n\n## Level One model summaries\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Recreated from BMLR Figure 8.9](25-multilevel-models-pt2_files/figure-revealjs/unnamed-chunk-9-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n. . .\n\n**Now let's consider if there is an association between the estimated slopes, estimated intercepts, and the type of instrument.**\n\n## Level Two Model\n\nThe slope and intercept for the $i^{th}$ musician can be modeled as\\\n\n$$\\begin{aligned}&a_i = \\alpha_0 + \\alpha_1 ~ Orchestra_i + u_i \\\\\n&b_i = \\beta_0 + \\beta_1 ~ Orchestra_i + v_i\\end{aligned}$$\n\n::: callout-note\nThe response variable in the Level Two models are not observed outcomes but the (fitted) slope and intercept from each musician\n:::\n\n## Application exercise\n\n::: appex\nüìã [AE 15: Introduction to Multilevel models](../ae/ae-15-multilevel-models.html)\n:::\n\nSee Part 4: Level Two Models.\n\n## Estimated coefficients by instrument\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](25-multilevel-models-pt2_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## Level Two model\n\n**Model for intercepts**\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n|term        | estimate| std.error| statistic| p.value|\n|:-----------|--------:|---------:|---------:|-------:|\n|(Intercept) |   16.283|     0.671|    24.249|   0.000|\n|orchestra   |    1.411|     0.991|     1.424|   0.163|\n:::\n:::\n\n**Model for slopes**\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n|term        | estimate| std.error| statistic| p.value|\n|:-----------|--------:|---------:|---------:|-------:|\n|(Intercept) |   -0.771|     0.851|    -0.906|   0.373|\n|orchestra   |   -1.406|     1.203|    -1.168|   0.253|\n:::\n:::\n\n## Writing out the models\n\n**Level One**\n\n\n$$\\hat{na}_{ij}  = \\hat{a}_i + \\hat{b}_i ~ LargeEnsemble_{ij}$$\n\n\nfor each musician.\n\n. . .\n\n**Level Two**\n\n```{=tex}\n\\begin{aligned}&\\hat{a}_i = 16.283 + 1.411 ~ Orchestra_i \\\\\n&\\hat{b}_i = -0.771 - 1.406 ~ Orchestra_i\\end{aligned}\n```\n## Composite model {.midi}\n\n```{=tex}\n\\begin{aligned}\\hat{na}_i &= 16.283 + 1.411 ~ Orchestra_i - 0.771 ~ LargeEnsemble_{ij} \\\\\n&- 1.406 ~ Orchestra:LargeEnsemble_{ij}\\end{aligned}\n```\n::: question\n-   What is the predicted average performance anxiety before solos and small ensemble performances for vocalists and keyboardists? For those who play orchestral instruments?\n\n-   What is the predicted average performance anxiety before large ensemble performances for those who play orchestral instruments?\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncountdown(minutes = 3, seconds= 0)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"countdown\" id=\"timer_63879986\" style=\"right:0;bottom:0;\" data-warnwhen=\"0\">\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">03</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n:::\n:::\n\n## Disadvantages to this approach\n\n‚ö†Ô∏è Weighs each musician the same regardless of number of diary entries\n\n‚ö†Ô∏è Drops subjects who have missing values for slope (7 individuals who didn't play a large ensemble performance)\n\n‚ö†Ô∏è Does not share strength effectively across individuals.\n\n## Application exercise\n\n::: appex\nüìã [AE 15: Introduction to Multilevel models](../ae/ae-15-multilevel-models.html)\n:::\n\nSee Part 5: Distribution of $R^2$ values.\n\n# Unified approach to two-level modeling\n\n------------------------------------------------------------------------\n\n## Framework {.midi}\n\nLet $Y_{ij}$ be the performance anxiety for the $i^{th}$ musician before performance $j$.\n\n**Level One**\n\n\n$$Y_{ij} = a_i + b_i ~ LargeEnsemble_{ij} + \\epsilon_{ij}$$\n\n\n**Level Two**\n\n```{=tex}\n\\begin{aligned}&a_i = \\alpha_0 + \\alpha_1 ~ Orchestra_i+ u_i\\\\\n&b_i = \\beta_0 + \\beta_1~Orchestra_i + v_i\\end{aligned}\n```\nCoefficients are estimated using likelihood-based methods (instead of least squares) to address the previously mentioned disadvantages\n\n## Composite model {.midi}\n\nPlug in the equations for $a_i$ and $b_i$ to get the **composite model** $$\\begin{aligned}Y_{ij} &= (\\alpha_0 + \\alpha_1 ~ Orchestra_i + \\beta_0 ~ LargeEnsemble_{ij} \\\\ \n&+ \\beta_1 ~ Orchestra_i:LargeEnsemble_{ij})\\\\\n&+ (u_i + v_i ~ LargeEnsemble_{ij} + \\epsilon_{ij})\\end{aligned}$$\n\n-   The **fixed effects** to estimate are $\\alpha_0, \\alpha_1, \\beta_0, \\beta_1$\n-   The **error terms** are $u_i, v_i, \\epsilon_{ij}$\n    -   We will estimate variability in the error terms $\\sigma_u, \\sigma_v, \\sigma_\\epsilon$\n\n. . .\n\n::: callout-note\nWe no longer need to estimate $a_i$ and $b_i$ directly as we did earlier. They conceptually connect the Level One and Level Two models.\n:::\n\n## Error terms {.midi}\n\n-   We generally assume that the error terms are normally distributed, e.g. error associated with each performance of a given musician is $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n\n-   For the Level Two models, the errors are\n\n    -   $u_i$: deviation of musician $i$ from the mean performance anxiety before solos and small ensembles after accounting for the instrument\n    -   $v_i$: deviance of musician $i$ from the mean difference in performance anxiety between large ensembles and other performance types after accounting for instrument\n\n-   We will also estimate $\\rho_{uv}$ to account for fact that $u_i$ (the intercepts) and $v_i$ (the slopes) are correlated for the $i^{th}$ musician\n\n## Slopes vs intercepts by musician\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Recreated from Figure 8.11](25-multilevel-models-pt2_files/figure-revealjs/unnamed-chunk-14-1.png){fig-align='center' width=90%}\n:::\n:::\n\n::: question\nDescribe what we learn about the association between the slopes and intercepts based on this plot.\n:::\n\n------------------------------------------------------------------------\n\n## Distribution of Level Two errors\n\nUse a **multivariate normal** distribution for the Level Two error terms $$\\left[ \\begin{array}{c}\n            u_{i} \\\\ v_{i}\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_{u}^{2} & \\rho_{uv}\\sigma_{u}\\sigma_v \\\\\n            \\rho_{uv}\\sigma_{u}\\sigma_v & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)$$\n\nwhere $\\sigma^2_u$ and $\\sigma^2_v$ are the variance of $u_i$'s and $v_i$'s respectively, and $\\sigma_{uv} = \\rho_{uv}\\sigma_u\\sigma_v$ is covariance between $u_i$ and $v_i$\n\n-   What does it mean for $\\rho_{uv} > 0$?\n-   What does it mean for $\\rho_{uv} < 0$?\n\n------------------------------------------------------------------------\n\n## Visualizing multivariate normal distribution\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Recreated from Figure 8.12](25-multilevel-models-pt2_files/figure-revealjs/contour-boundary-1.png){fig-align='center' width=60%}\n:::\n:::\n\n------------------------------------------------------------------------\n\n## Fit the model in R\n\nFit multilevel model using **tidymodels** and the **multilevelmod** R packages. Display results using the `tidy()` function from the **broom.mixed** package.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"1|2|3|6|7|8|9\"}\nlibrary(tidymodels)\nlibrary(multilevelmod)\nlibrary(broom.mixed)\n\nmusic_fit <- \n  linear_reg() |>\n  set_engine(\"lmer\") |>\n  fit(na ~ orchestra + large_ensemble +\n        orchestra:large_ensemble + (large_ensemble|id),\n      data = music)\n\ntidy(music_fit) |> kable(digits = 3)\n```\n:::\n\n## Fit the model in R\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n|effect   |group    |term                             | estimate| std.error| statistic|\n|:--------|:--------|:--------------------------------|--------:|---------:|---------:|\n|fixed    |NA       |(Intercept)                      |   15.930|     0.641|    24.833|\n|fixed    |NA       |orchestra1                       |    1.693|     0.945|     1.791|\n|fixed    |NA       |large_ensemble1                  |   -0.911|     0.845|    -1.077|\n|fixed    |NA       |orchestra1:large_ensemble1       |   -1.424|     1.099|    -1.295|\n|ran_pars |id       |sd__(Intercept)                  |    2.378|        NA|        NA|\n|ran_pars |id       |cor__(Intercept).large_ensemble1 |   -0.635|        NA|        NA|\n|ran_pars |id       |sd__large_ensemble1              |    0.672|        NA|        NA|\n|ran_pars |Residual |sd__Observation                  |    4.670|        NA|        NA|\n:::\n:::\n\n## Final model\n\n```{=tex}\n\\begin{aligned}\\hat{na}_i &= 15.930 + 1.693 ~ Orchestra_i - 0.911 ~ LargeEnsemble_{ij} \\\\\n&- 1.424 ~ Orchestra_i:LargeEnsemble_{ij} \\\\[5pt]\n&\\hat{\\sigma}_{u} = 2.378 \\hspace{20mm} \\hat{\\sigma}_{v} = 0.672 \\hspace{20mm} \\hat{\\sigma}_{\\epsilon} = 4.670 \\\\\n&\\hat{\\rho}_{uv} = -0.635\\end{aligned}\n```\n## Acknowledgements\n\nThe content in the slides is from - [BMLR: Chapter 7 - Correlated data](https://bookdown.org/roback/bookdown-BeyondMLR/ch-corrdata.html) - [BMLR: Chapter 8 - Introduction to Multilevel Models](https://bookdown.org/roback/bookdown-BeyondMLR/ch-multilevelintro.html)\n\n-   Sadler, Michael E., and Christopher J. Miller. 2010. \"Performance Anxiety: A Longitudinal Study of the Roles of Personality and Experience in Musicians.\" Social Psychological and Personality Science 1 (3): 280--87. http://dx.doi.org/10.1177/1948550610370492.\n",
    "supporting": [
      "25-multilevel-models-pt2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/countdown-0.3.5/countdown.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/countdown-0.3.5/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    function fireSlideChanged(previousSlide, currentSlide) {\n\n      // dispatch for htmlwidgets\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for reveal\n    if (window.Reveal) {\n      window.Reveal.addEventListener(\"slidechanged\", function(event) {\n        fireSlideChanged(event.previousSlide, event.currentSlide);\n      });\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}