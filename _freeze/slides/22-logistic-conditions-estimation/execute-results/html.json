{
  "hash": "62b713df5ee575c4d58efce130a91c2c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Logistic Regression: Assumptions + Estimation\"\nauthor: \"Prof. Maria Tackett\"\ndate: \"2024-11-19\"\ndate-format: \"MMM DD, YYYY\"\nfooter: \"[ðŸ”— STA 221 - Fall 2024](https://sta221-fa24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    multiplex: false\n    transition: fade\n    slide-number: true\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\n    \nbibliography: references.bib\n---\n\n\n\n\n\n## Announcements  {.midi}\n\n-   Lab 06 due Thursday, November 21 at 11:59pm\n\n-   HW 04 released later today. Due Thursday, November 21\n\n-   Project meetings: November 25 and 26\n\n    -   [Click here](https://docs.google.com/spreadsheets/d/1_TiZ84kWGs7GiTl9Sph5BkgOUScjIAlOrKyU1uAkl1I/edit?usp=sharing) to sign up (1 slot per team) by November 22\n\n-   Statistics experience due Tuesday, November 26\n\n-   Project: Draft report due + peer review in December 2 lab\n\n## Topics\n\n-   Conditions for logistic regression\n\n-   Estimating coefficients for logistic regression model\n\n## Computational setup\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(knitr)\nlibrary(kableExtra)\nlibrary(Stat2Data)  #empirical logit plots\nlibrary(patchwork)\n\n# set default theme in ggplot2\nggplot2::theme_set(ggplot2::theme_bw())\n```\n:::\n\n\n\n## COVID-19 infection prevention practices at food establishments\n\nResearchers at Wollo University in Ethiopia conducted a study in July and August 2020 to understand factors associated with good COVID-19 infection prevention practices at food establishments. Their study is published in @andualem2022covid.\n\nThey were particularly interested in the understanding implementation of prevention practices at food establishments, given the workersâ€™ increased risk due to daily contact with customers.\n\n## Access to personal protective equipment {.midi}\n\nWe will use the data from @andualem2022covid to explore the association between age, sex, years of service, and whether someone works at a food establishment with access to personal protective equipment (PPE) as of August 2020. We will use access to PPE as a proxy for wearing PPE.\n\nThe study participants were selected using a simple random sampling at the selected establishments.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n| age|sex    | years|ppe_access |\n|---:|:------|-----:|:----------|\n|  34|Male   |     2|1          |\n|  32|Female |     3|1          |\n|  32|Female |     1|1          |\n|  40|Male   |     4|1          |\n|  32|Male   |    10|1          |\n\n\n:::\n:::\n\n\n\n## Full model results\n\n![](images/22/logistic-output.PNG){fig-align=\"center\"}\n\n<!--# see these notes for empirical logit: https://sta210-fa23.netlify.app/slides/20-logistic-inf.html#/calculating-empirical-logit-categorical-predictor-->\n\n## Bivariate EDA: categorical predictor\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Bivariate EDA: quantitative predictor\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Empirical logit\n\nThe **empirical logit** is the log of the observed odds:\n\n$$\n\\text{logit}(\\hat{p}) = \\log\\Big(\\frac{\\hat{p}}{1 - \\hat{p}}\\Big) = \\log\\Big(\\frac{\\# \\text{Yes}}{\\# \\text{No}}\\Big)\n$$\n\n## Calculating empirical logit (categorical predictor)\n\nIf the predictor is categorical, we can calculate the empirical logit for each level of the predictor.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncovid_df |>\n  count(sex, ppe_access) |>\n  group_by(sex) |>\n  mutate(prop = n/sum(n)) |>\n  filter(ppe_access == \"1\") |>\n  mutate(emp_logit = log(prop/(1-prop)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 Ã— 5\n# Groups:   sex [2]\n  sex    ppe_access     n  prop emp_logit\n  <fct>  <fct>      <int> <dbl>     <dbl>\n1 Female 1            103 0.475    -0.101\n2 Male   1            119 0.647     0.605\n```\n\n\n:::\n:::\n\n\n\n## Calculating empirical logit (quantitative predictor)\n\n1.  Divide the range of the predictor into intervals with approximately equal number of cases. (If you have enough observations, use 5 - 10 intervals.)\n\n2.  Compute the empirical logit for each interval\n\n. . .\n\nYou can then calculate the mean value of the predictor in each interval and create a plot of the empirical logit versus the mean value of the predictor in each interval.\n\n## Empirical logit plot in R (quantitative predictor)\n\nCreated using `dplyr` and `ggplot` functions.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-6-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Empirical logit plot in R (quantitative predictor)\n\nCreated using `dplyr` and `ggplot` functions.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncovid_df |> \n  mutate(age_bin = cut_number(age, n = 10)) |>\n  group_by(age_bin) |>\n  mutate(mean_age = mean(age)) |>\n  count(mean_age, ppe_access) |>\n  mutate(prop = n/sum(n)) |>\n  filter(ppe_access == \"1\") |>\n  mutate(emp_logit = log(prop/(1-prop))) |>\n  ggplot(aes(x = mean_age, y = emp_logit)) + \n  geom_point() + \n  geom_smooth(method = \"lm\", se = FALSE) +\n  labs(x = \"Mean Age\", \n       y = \"Empirical logit\", \n       title = \"Empirical logit of PPE Access vs. Age\")\n```\n:::\n\n\n\n## Empirical logit plot in R (quantitative predictor)\n\nUsing the `emplogitplot1` function from the **Stat2Data** R package\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nemplogitplot1(ppe_access ~ age,  data = covid_df, ngroups = 10)\n```\n\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Empirical logit plot in R (interactions)\n\nUsing the `emplogitplot2` function from the **Stat2Data** R package\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nemplogitplot2(ppe_access ~ age + sex, data = covid_df, \n              ngroups = 10, \n              putlegend = \"bottomright\")\n```\n\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-9-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Logistic regression model {.midi}\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nppe_model <- glm(ppe_access ~ age + sex + years, \n                 data = covid_df, family = binomial)\ntidy(ppe_model, conf.int = TRUE) |>\n  kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n|term        | estimate| std.error| statistic| p.value| conf.low| conf.high|\n|:-----------|--------:|---------:|---------:|-------:|--------:|---------:|\n|(Intercept) |   -2.127|     0.458|    -4.641|   0.000|   -3.058|    -1.257|\n|age         |    0.056|     0.017|     3.210|   0.001|    0.023|     0.091|\n|sexMale     |    0.341|     0.224|     1.524|   0.128|   -0.098|     0.780|\n|years       |    0.264|     0.066|     4.010|   0.000|    0.143|     0.401|\n\n\n:::\n:::\n\n\n\n## Visualizing coefficient estimates {.midi}\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel_odds_ratios <- tidy(ppe_model, exponentiate = TRUE, conf.int = TRUE)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = model_odds_ratios, aes(x = term, y = estimate)) +\n  geom_point() +\n  geom_hline(yintercept = 1, lty = 2) + \n  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+\n  labs(title = \"Adjusted odds ratios\",\n       x = \"\",\n       y = \"Estimated AOR\") +\n  coord_flip()\n```\n\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-12-1.png){fig-align='center' width=55%}\n:::\n:::\n\n\n\n# Assumptions for logistic regression\n\n## Assumptions for logistic regression\n\n<!--# https://bookdown.org/roback/bookdown-BeyondMLR/ch-logreg.html#logistic-regression-assumptions-->\n\n-   **Linearity:** The log-odds have a linear relationship with the predictors.\n\n-   **Randomness:** The data were obtained from a random process\n\n-   **Independence:** The observations are independent from one another.\n\n## Checking linearity\n\nCheck the empirical logit plots for the <u>quantitative </u>predictors\n\n::: columns\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nemplogitplot1(ppe_access ~ age, data = covid_df, \n              ngroups = 10)\n```\n\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-13-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nemplogitplot1(ppe_access ~ years, data = covid_df, \n              ngroups = 5)\n```\n\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-14-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n:::\n\n. . .\n\n::: midi\nâœ… The linearity condition is satisfied. There is generally a linear relationship between the empirical logit and the quantitative predictor variables\n:::\n\n## Checking randomness\n\nWe can check the randomness condition based on the context of the data and how the observations were collected.\n\n-   Was the sample randomly selected?\n\n-   If the sample was not randomly selected, ask whether there is reason to believe the observations in the sample differ systematically from the population of interest\n\n. . .\n\nâœ… The randomness condition is satisfied. The paper states the participants were selected using simple random sampling at selected establishments. We can reasonably treat this sample as representative of the population.\n\n## Checking independence\n\n-   We can check the independence condition based on the context of the data and how the observations were collected.\n\n-   Independence is most often violated if the data were collected over time or there is a strong spatial relationship between the observations.\n\n. . .\n\nâœ… We will treat this sample as independent. If given the data, we may want to further investigate potential correlation within an establishment.\n\n# Estimating $\\boldsymbol{\\beta}$ \n\n## Estimating $\\boldsymbol{\\beta}$\n\nRecall that the coefficients for logistic regression are estimated using maximum likelihood estimation.\n\n$$\n\\begin{aligned}\\log &L(\\boldsymbol\\beta | x_1, \\dots, x_n, y_1, \\dots, y_n) \\\\\n&= \\sum_{i=1}^n y_i \\mathbf{x}_i^T \\boldsymbol\\beta - \\sum_{i=1}^n \\log(1+ \\exp\\{\\mathbf{x}_i^T \\boldsymbol{\\beta}\\})\n\\end{aligned}\n$$\n\n## Estimating $\\boldsymbol{\\beta}$ \n\nTake the derivative and set it equal to 0 to solve for $\\boldsymbol{\\beta}$. ([Click here](https://canvas.duke.edu/courses/38867/discussion_topics/122356) for the full derivation.)\\\n$$\n\\begin{aligned}\n\\frac{\\partial \\log L}{\\partial \\boldsymbol\\beta} =\\sum_{i=1}^n y_i \\mathbf{x}_i^T\n&- \\sum_{i=1}^n \\frac{\\exp\\{\\mathbf{x}_i^T \\boldsymbol\\beta\\} x_i^T}{1+\\exp\\{\\mathbf{x}_i^T \\boldsymbol\\beta\\}} = 0\n\\end{aligned}\n$$\n\n. . .\n\nThere is no closed form solution. We can find the solution numerically using the **Newton-Raphson method**.\n\n## Newton-Raphson method\n\nNewton-Raphson is a numerical method for finding solutions to $f(x) = 0$ . Steps of the Newton-Raphson method:\n\n1.  Start with an initial guess $\\theta^{(0)}$ .\n\n2.  For each iteration,\n\n    $$\n    \\theta^{(t+1)} = \\theta^{(t)} - \\frac{f(\\theta^{(t)})}{f^{\\prime}(\\theta^{(t)})}\n    $$\n\n3.  Stop when the convergence criteria is satisfied.\n\n## Newton-Raphson method\n\n![](images/22/newton-raphson.jpeg){width=\"75%\"}\n\nSource: [LibreTexts-Mathematics](https://math.libretexts.org/Bookshelves/Calculus/Map%3A_Calculus__Early_Transcendentals_%28Stewart%29/04%3A_Applications_of_Differentiation/4.08%3A_Newton%27s_Method)\n\n## Example {.midi}\n\nLet's find the solution (root) of the function $$f(x) = x^3 - 20$$\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](22-logistic-conditions-estimation_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Example\n\nSuppose the convergence criteria be $\\Delta = |\\theta^{(t+1)} - \\theta^{(t)}| < 0.001$ . We'll start with an initial guess of $\\theta^{(0)} = 3$\n\n. . .\n\n$$\n\\theta^{(1)} = 3 - \\frac{3^3 - 20}{3*3^2} = 2.740741\n$$\n\n. . .\n\n$$\\Delta = |2.740741 - 3| = 0.259259\n$$\n\n. . .\n\n$$\n\\theta^{(2)} = 2.740741 - \\frac{2.740741^3 - 20}{3*2.740741^2} = 2.71467\n$$\n\n. . .\n\n$$\\Delta = |2.71467 - 2.740741| = 0.026071\n$$\n\n## \n\n## Example\n\n$$\n\\theta^{(3)} = 2.71467 - \\frac{2.71467^3 - 20}{3*2.71467^2} = 2.714418\n$$\n\n. . .\n\n$$\n\\Delta = |2.714418 - 2.71467| = 0.000252 < 0.001\n$$\n\n::: center\n**The solution is** $\\mathbf{\\approx 2.714418}$\n:::\n\n## Score vector & Hessian {.midi}\n\nGiven parameter $\\boldsymbol{\\theta} = [\\theta_1, \\ldots, \\theta_p]^T$ and log-likelihood, $\\log L (\\boldsymbol{\\theta}|\\mathbf{X})$ , then\n\n. . .\n\n$$\n\\text{Score vector } =\\nabla_{\\boldsymbol{\\theta}} \\log L = \\begin{bmatrix}\\frac{\\partial \\log L}{\\partial \\theta_1} \\\\ \\vdots \\\\ \\frac{\\partial \\log L}{\\partial \\theta_p} \\end{bmatrix}\n$$\n\n$$\n\\text{Hessian} = \\nabla^2_{\\boldsymbol{\\theta}} \\log L = \\begin{bmatrix}\\frac{\\partial^2 \\log L}{\\partial \\theta_1^2} &\\frac{\\partial^2 \\log L}{\\partial \\theta_1\\theta_2} & \\dots & \\frac{\\partial^2 \\log L}{\\partial \\theta_1\\theta_p} \\\\\n\\frac{\\partial^2 \\log L}{\\partial \\theta_2\\theta_1} & \\frac{\\partial^2 \\log L}{\\partial \\theta_2^2}  & \\dots & \\frac{\\partial^2 \\log L}{\\partial \\theta_2\\theta_p} \\\\\n\\vdots & \\vdots & \\dots & \\vdots \\\\ \n\\frac{\\partial^2 \\log L}{\\partial \\theta_p\\theta_1} & \\frac{\\partial^2 \\log L}{\\partial \\theta_p\\theta_2} & \\dots & \\frac{\\partial^2 \\log L}{\\partial \\theta_p^2}\\end{bmatrix}\n$$\n\n## Newton-Raphson for logistic regression\n\n1.  Start with an initial guess $\\boldsymbol{\\beta}^{(0)}$ .\n\n2.  For each iteration,\n\n    $$\n    \\boldsymbol{\\beta}^{(t+1)} = \\boldsymbol{\\beta}^{(t)} - \\big(\\nabla_{\\boldsymbol{\\beta}}^2 \\log L(\\boldsymbol{\\beta}^{(t)}|\\mathbf{X})\\big)^{-1}\\big(\\nabla_{\\boldsymbol{\\beta}} \\log L(\\boldsymbol{\\beta}^{(t)}|\\mathbf{X})\\big)\n    $$\n\n3.  Stop when the convergence criteria is satisfied.\n\n## Newton-Raphson for logistic regression  {.midi}\n\n$$\n\\log L = \\sum_{i=1}^n y_i \\mathbf{x}_i^T \\boldsymbol\\beta - \\sum_{i=1}^n \\log(1+ \\exp\\{\\mathbf{x}_i^T \\boldsymbol{\\beta}\\})\n$$\n\n<br>\n\n$$\n\\nabla_{\\boldsymbol{\\beta}} \\log L = \\sum_{i=1}^n \\Bigg[y_i\n- \\frac{\\exp\\{\\mathbf{x}_i^T \\boldsymbol\\beta\\}}{1+\\exp\\{\\mathbf{x}_i^T \\boldsymbol\\beta\\}}\\Bigg]\\mathbf{x}_i\n$$\n\n<br>\n\n$$\n\\nabla^2_{\\boldsymbol{\\beta}} \\log L = \\\n- \\sum_{i=1}^n \\Big(\\frac{1}{1+\\exp\\{\\mathbf{x}_i^T \\boldsymbol\\beta\\}}\\Big)\\Big(\\frac{\\exp\\{\\mathbf{x}_i^T \\boldsymbol\\beta\\}}{1+\\exp\\{\\mathbf{x}_i^T \\boldsymbol\\beta\\}}\\Big)\\mathbf{x}_i\\mathbf{x}_i^T\n$$\n\n## PPE access example \n\n::: appex\nðŸ“‹ <https://sta221-fa24.netlify.app/ae/ae-07-newton-raphson.html>\n:::\n\n## References\n",
    "supporting": [
      "22-logistic-conditions-estimation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}