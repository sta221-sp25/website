{
  "hash": "222af75245a3d766e55a96ac6b4b8396",
  "result": {
    "markdown": "---\ntitle: \"AE 15: Inference for logistic regression\"\ndate: \"Nov 13, 2023\"\neditor: visual\nexecute: \n  warning: false\n  message: false\n---\n\n\n::: callout-important\nGo to the [course GitHub organization](https://github.com/sta210-fa23) and locate your `ae-15` repo to get started.Render, commit, and push your responses to GitHub by the end of class.\\\n\\\nThe responses are due in your GitHub repo no later than Thursday, November 16 at 11:59pm.\n:::\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(knitr)\n```\n:::\n\n\n## Response to Leukemia treatment\n\nToday's data is from a study where 51 untreated adult patients with Acute Myeloid Leukemia who were given a course of treatment, and they were assessed as to their response to the treatment.[^1]\n\n[^1]: The data set is from the Stat2Data R package. This AE is adapted from exercises in *Stat 2.*\n\nThe goal of today's analysis is to use pre-treatment factors to predict how likely it is a patient will respond to the treatment.\n\nWe will use the following variables:\n\n-   `Age`: Age at diagnosis (in years)\n-   `Smear`: Differential percentage of blasts\n-   `Infil`: Percentage of absolute marrow leukemia infiltrate\n-   `Index`: Percentage labeling index of the bone marrow leukemia cells\n-   `Blasts`: Absolute number of blasts, in thousands\n-   `Temp`: Highest temperature of the patient prior to treatment, in degrees Fahrenheit\n-   `Resp`: 1 = responded to treatment or 0 = failed to respond\n\n\n::: {.cell}\n\n```{.r .cell-code}\nleukemia <- read_csv(\"data/leukemia.csv\") |>\n  mutate(Resp = factor(Resp))\n```\n:::\n\n\n## Estimating coefficients for logistic regression\n\n### Illustrating maximum likelihood estimation (MLE)\n\nSuppose we want to use the data to understand the probability a randomly selected adult diagnosed with leukemia will respond to the treatment.\n\nHere are the results from our data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nleukemia %>%\n  count(Resp) %>%\n  mutate(prob = n /sum(n))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 3\n  Resp      n  prob\n  <fct> <int> <dbl>\n1 0        27 0.529\n2 1        24 0.471\n```\n:::\n:::\n\n\nLet's set up some notation:\n\n-   $Y$: Bernoulli random variable indicating whether an adult diagnosed with leukemia responds to the treatment\n-   $y_i$: outcome for an individual adult (1: responded to treatment or 0: failed to respond)\n-   $p$: probability a randomly selected adult diagnosed with leukemia responds to the treatment\n\nOur goal is to find the most likely value of $p$ given our data.\n\nThe likelihood function of the outcome for a single randomly selected adult diagnosed with leukemia is $$P(Y = y_i) = p^{y_i}(1-p)^{1-y_i}$$\n\nThe likelihood function, i.e. the joint probability, for the outcomes of 51 adults is\n\n$$L = P(y_1, y_2, \\ldots, y_{51}) = \\prod_{i = 1}^{51} p^{y_i} (1 - p)^{1 - y_i}$$\n\nWe often use the log of the likelihood function, so we can work with sums rather than products.\n\n$$\\begin{aligned}\\log L = \\log[P(y_1, y_2, \\ldots, y_{51})] &= \\log\\Big[\\prod_{i = 1}^{51} p^{y_i} (1 - p)^{1 - y_i}\\Big] \\\\ \n&= \\sum_{i=1}^{51} y_i \\log(p) + (1 - y_i)\\log(1 - p)\\end{aligned}$$\n\nWe can rewrite the equation and plug in the results from our data:\n\n$$\\begin{aligned} \\log L &= \\sum_{i=1}^{51} y_i \\log(p) + (1 - y_i)\\log(1 - p) \\\\ \n& = \\log(p)\\sum_{i=1}^{51}y_i + \\log(1 - p)\\sum_{i=1}^{51}(1 - y_{i}) \\\\\n& = \\log(p)\\times 24 + \\log(1 - p)\\times 27 \\end{aligned}$$\n\nLet's plug in different values of $p$ and find the value that maximizes this equation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- seq(0.01,.99,0.005)\nlogL <- log(p)*24+ log(1-p)*27 #log likelihood\nL <- exp(logL) #likelihood\nresults <- tibble(p, logL, L)\n\n#identify the the mle\nresults <- results %>%\n  mutate(mle = if_else(logL == max(results$logL), \"1\", \"0\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot log likelihood\nggplot(data = results, aes(x = p, y = logL)) +\n  geom_point(aes(color = mle)) + \n  geom_line() +\n  scale_color_manual(values = c(\"gray\", \"red\")) + \n  scale_x_continuous(breaks = seq(0,1,.1)) + \n  labs(title = \"Maximizing Log Liklehood\") \n```\n\n::: {.cell-output-display}\n![](ae-15-logistic-inference_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#plot likelihood\nggplot(data = results, aes(x = p, y = L)) +\n  geom_point(aes(color = mle)) + \n  geom_line() +\n  scale_color_manual(values = c(\"gray\", \"red\")) + \n  scale_x_continuous(breaks = seq(0,1,.1)) + \n  labs(title = \"Maximizing Likelihood\") \n```\n\n::: {.cell-output-display}\n![](ae-15-logistic-inference_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nThe MLE, the value that maximizes the (log) likelihood function is\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresults %>%\n  filter(mle == 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 4\n      p  logL        L mle  \n  <dbl> <dbl>    <dbl> <chr>\n1  0.47 -35.3 4.85e-16 1    \n```\n:::\n:::\n\n\nAs we might expect, this is the sample proportion $\\hat{p}$ from our data.\n\n### Extending to logistic regression\n\nThe parameters for logistic regression are estimated using maximum likelihood estimation. Suppose we have the model\n\n$$\\log\\big(\\frac{\\pi}{1-\\pi}\\big) = \\beta_0 + \\beta_1 x$$\n\nThe estimates $\\hat{\\beta}_0$ and $\\hat{\\beta}_1$ are the ones maximize the log likelihood function\n\n$$L = P(y_1, y_2, \\ldots, y_n) = \\prod_{i = 1}^{n} \\pi^{y_i}(1-\\pi)^{1-y_i}$$\n\nwhere $$\\pi = \\frac{\\exp\\{\\beta_0 + \\beta_1x\\}}{1 + \\exp\\{\\beta_0 + \\beta_1x\\}}$$\n\nThere isn't a closed-form solution for the log-likelihood, so numerical methods such as Iterative Weighted Least Squares are used to estimate the coefficients (learn more about IWLS in STA 211 and STA 310). This is the method used to estimate the coefficients in R.\n\nLet's fit a model using `Age` as a predictor and see some details of coefficient estimation.[^2] This is for demonstration purposes.\n\n[^2]: Trace function for current version of R from [StackOverflow](https://stackoverflow.com/questions/33320973/is-there-a-way-to-obtain-coefficients-for-each-step-of-the-optimization-algorith).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function that allows us to see the coefficients at each iteration\ntrace(glm.fit, quote(cat <- function(...) {\n  base::cat(...)\n  if (...length() >= 3 && identical(..3, \" Iterations - \")) print(coefold)\n}))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"glm.fit\"\n```\n:::\n\n```{.r .cell-code}\n# Fit model to see details\nresp_fit_details <- glm(Resp ~ Age, data = leukemia, \n                        family = \"binomial\", \n                        control = glm.control(trace = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nTracing glm.fit(x = structure(c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  .... on entry \nDeviance = 64.07455 Iterations - 1\nNULL\nDeviance = 64.0038 Iterations - 2\n[1]  2.44957126 -0.05199527\nDeviance = 64.00374 Iterations - 3\n[1]  2.18965178 -0.04660907\nDeviance = 64.00374 Iterations - 4\n[1]  2.196772 -0.046760\n```\n:::\n\n```{.r .cell-code}\nuntrace(glm.fit)\n```\n:::\n\n\n**Final model**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresp_fit <- logistic_reg() |>\n  fit(Resp ~ Age, data = leukemia, family = \"binomial\")\n\ntidy(resp_fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 5\n  term        estimate std.error statistic p.value\n  <chr>          <dbl>     <dbl>     <dbl>   <dbl>\n1 (Intercept)   2.20      1.01        2.18  0.0289\n2 Age          -0.0468    0.0195     -2.39  0.0166\n```\n:::\n:::\n\n\n## Inference for coefficients\n\n1.  Fit a model using `Temp` , `Age`, and `Index` to predict whether or not a patient responds to the treatment. Display the model and the 95% confidence interval for the model coefficients.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add code here\n```\n:::\n\n\n2.  Interpret the coefficient of `Temp` in the context of the data in terms of the odds an individual responds to the treatment.\n\n3.  Interpret the 95% confidence interval for the coefficient of `Temp` in terms of the odds an individual responds to the treatment.\n\n4.  What is the distribution of the test statistic associated with `Temp`?\n\n5.  Is `Temp` a useful predictor of the likelihood an individual responds to the treatment? Briefly explain.\n\n## Submission\n\n::: callout-important\nTo submit the AE:\n\n-   Render the document to produce the PDF with all of your work from today's class.\n-   Push all your work to your `ae-15` repo on GitHub. (You do not submit AEs on Gradescope).\n:::\n",
    "supporting": [
      "ae-15-logistic-inference_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}